import React, { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useLocation } from "wouter";
import { motion, AnimatePresence } from "framer-motion";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  ArrowLeft,
  ArrowRight,
  Building2,
  Mail,
  Settings,
  Key,
  CheckCircle,
  Users,
  Shield,
  Globe,
  Zap,
  FileText,
  Bell,
  Bot,
  Activity,
  Lock,
  Cloud,
  Database,
} from "lucide-react";
import { Textarea } from "@/components/ui/textarea";
import { useCreateTenant } from "@/hooks/use-tenants";
import { useToast } from "@/hooks/use-toast";

const formSchema = z.object({
  // Basic Information
  name: z.string().min(2, "Organization name must be at least 2 characters"),
  orgId: z
    .string()
    .min(2, "Organization ID must be at least 2 characters")
    .regex(
      /^[a-z0-9-]+$/,
      "Organization ID can only contain lowercase letters, numbers, and hyphens"
    ),
  adminEmail: z.string().email("Please enter a valid email address"),
  adminName: z.string().min(2, "Admin name must be at least 2 characters"),
  companyWebsite: z.string().url().optional().or(z.literal("")),

  // Modules
  enabledModules: z.array(z.string()).default([]),

  // Module Configurations
  moduleConfigs: z
    .object({
      authentication: z
        .object({
          providers: z.array(z.enum(["auth0", "azure-ad", "local", "saml"])).default([]),
          auth0: z
            .object({
              domain: z.string().optional(),
              clientId: z.string().optional(),
              clientSecret: z.string().optional(),
              audience: z.string().optional(),
            })
            .optional(),
          azureAd: z
            .object({
              tenantId: z.string().optional(),
              clientId: z.string().optional(),
              clientSecret: z.string().optional(),
              redirectUri: z.string().optional(),
            })
            .optional(),
          local: z
            .object({
              secretKey: z.string().optional(),
              expirationTime: z.string().optional(),
              algorithm: z.string().optional(),
            })
            .optional(),
          saml: z
            .object({
              entryPoint: z.string().optional(),
              issuer: z.string().optional(),
              cert: z.string().optional(),
            })
            .optional(),
        })
        .optional(),
      rbac: z
        .object({
          defaultRoles: z.array(z.string()).optional(),
          customPermissions: z.array(z.string()).optional(),
          inheritanceEnabled: z.boolean().optional(),
        })
        .optional(),
      logging: z
        .object({
          levels: z.array(z.enum(["error", "warn", "info", "debug", "trace"])).optional(),
          destinations: z.array(z.string()).optional(),
          retentionDays: z.number().optional(),
        })
        .optional(),
      notifications: z
        .object({
          channels: z.array(z.enum(["email", "sms", "push", "webhook"])).optional(),
          emailProvider: z.string().optional(),
          webhookUrl: z.string().optional(),
        })
        .optional(),
      aiCopilot: z
        .object({
          provider: z.enum(["openai", "azure-openai", "anthropic", "google"]).optional(),
          apiKey: z.string().optional(),
          model: z.string().optional(),
          features: z.array(z.string()).optional(),
        })
        .optional(),
    })
    .default({}),

  sendEmail: z.boolean().default(true),
});

type FormData = z.infer<typeof formSchema>;

const STEPS = [
  {
    id: "basic",
    title: "Basic Information",
    description: "Enter organization details and admin contact",
    icon: Building2,
  },
  {
    id: "modules",
    title: "Select Modules",
    description: "Choose the modules you want to enable",
    icon: Shield,
  },
  {
    id: "configuration",
    title: "Configure Modules",
    description: "Configure the selected modules",
    icon: Settings,
  },
  {
    id: "review",
    title: "Review & Create",
    description: "Review your configuration and create the tenant",
    icon: CheckCircle,
  },
];

const MODULES = [
  {
    id: "authentication",
    name: "Authentication Module",
    description: "Multiple authentication providers including Auth0, Azure AD, JWT, and SAML",
    icon: Lock,
    color: "bg-blue-500",
    providers: ["Auth0", "Azure AD", "JWT", "SAML"],
  },
  {
    id: "rbac",
    name: "RBAC (Role-Based Access Control)",
    description: "Advanced permission management with roles and policies",
    icon: Users,
    color: "bg-green-500",
  },
  {
    id: "logging",
    name: "Logging and Monitoring",
    description: "Comprehensive audit trails and system monitoring",
    icon: Activity,
    color: "bg-orange-500",
  },
  {
    id: "notifications",
    name: "Notifications",
    description: "Multi-channel notification system (Email, SMS, Push, Webhooks)",
    icon: Bell,
    color: "bg-purple-500",
  },
  {
    id: "aiCopilot",
    name: "AI Copilot",
    description: "AI-powered assistance and automation features",
    icon: Bot,
    color: "bg-indigo-500",
  },
];

export default function OnboardingWizard() {
  const [currentStep, setCurrentStep] = useState(0);
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const createTenant = useCreateTenant();

  const form = useForm<FormData>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: "",
      orgId: "",
      adminEmail: "",
      adminName: "",
      companyWebsite: "",
      enabledModules: [],
      moduleConfigs: {
        authentication: { providers: [] },
        rbac: {},
        logging: { levels: [] },
        notifications: { channels: [] },
        aiCopilot: {},
      },
      sendEmail: true,
    },
  });

  const watchedModules = form.watch("enabledModules") || [];
  const watchedAuthProviders = form.watch("moduleConfigs.authentication.providers");

  const handleNext = async () => {
    let fieldsToValidate: (keyof FormData)[] = [];

    if (currentStep === 0) {
      fieldsToValidate = ["name", "orgId", "adminEmail", "adminName"];
    }

    const isValid = await form.trigger(fieldsToValidate as any);

    if (isValid) {
      if (currentStep < STEPS.length - 1) {
        setCurrentStep(currentStep + 1);
      }
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
    }
  };

  const onSubmit = async (data: FormData) => {
    try {
      // Transform module names from frontend format to backend format
      const moduleNameMap: Record<string, string> = {
        authentication: "auth",
        rbac: "rbac",
        logging: "logging",
        notifications: "notifications",
        aiCopilot: "ai-copilot",
      };

      const transformedModules = data.enabledModules.map(module => moduleNameMap[module] || module);

      // Transform moduleConfigs object keys to match backend expectations
      const transformedModuleConfigs: any = {};
      Object.entries(data.moduleConfigs).forEach(([key, value]) => {
        const transformedKey = moduleNameMap[key] || key;

        // Special handling for authentication module
        if (transformedKey === "auth" && value && typeof value === "object") {
          const authConfig = value as any;
          const transformedAuth = { ...authConfig };

          // Transform providers from simple strings to complex objects
          if (authConfig.providers && Array.isArray(authConfig.providers)) {
            transformedAuth.providers = authConfig.providers.map(
              (providerType: string, index: number) => {
                // Get provider-specific config
                let config = {};
                const providerKey = providerType.replace("-", "").replace("_", ""); // "azure-ad" -> "azuread"

                // Map provider keys to form field names
                const configKeyMap: Record<string, string> = {
                  "azure-ad": "azureAd",
                  auth0: "auth0",
                  local: "local",
                  saml: "saml",
                };

                const formConfigKey = configKeyMap[providerType];
                if (formConfigKey && authConfig[formConfigKey]) {
                  config = authConfig[formConfigKey];
                }

                // Create provider object structure expected by backend
                return {
                  type: providerType,
                  name: providerType
                    .split("-")
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(" "), // "azure-ad" -> "Azure Ad"
                  priority: index + 1,
                  config: config,
                  userMapping: {
                    emailField: "email",
                    nameField: "name",
                  },
                  enabled: true,
                };
              }
            );

            // Remove the individual provider config objects since they're now in providers array
            delete transformedAuth.auth0;
            delete transformedAuth.azureAd;
            delete transformedAuth.local;
            delete transformedAuth.saml;
          }

          transformedModuleConfigs[transformedKey] = value;
        }
      });

      // Transform the data to match the API format
      const transformedData = {
        name: data.name,
        orgId: data.orgId,
        adminEmail: data.adminEmail,
        adminName: data.adminName,
        sendEmail: data.sendEmail,
        enabledModules: data.enabledModules,
        moduleConfigs: transformedModuleConfigs,
        metadata: {
          adminName: data.adminName,
          companyWebsite: data.companyWebsite,
        },
      };

      await createTenant.mutateAsync(transformedData as any);

      toast({
        title: "Tenant created successfully!",
        description: `Onboarding email has been sent to ${data.adminEmail}`,
      });

      // Redirect to success page
      setLocation("/tenants/success");
    } catch (error) {
      toast({
        title: "Failed to create tenant",
        description: "Please try again or contact support",
        variant: "destructive",
      });
    }
  };

  const progress = ((currentStep + 1) / STEPS.length) * 100;

  return (
    <div className="max-w-4xl mx-auto">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-slate-900">Tenant Onboarding</h1>
        <p className="text-slate-600 mt-2">Set up a new tenant with guided configuration</p>
      </div>

      {/* Progress */}
      <div className="mb-8">
        <Progress value={progress} className="h-2" />
        <div className="flex justify-between mt-4">
          {STEPS.map((step, index) => {
            const Icon = step.icon;
            return (
              <div
                key={step.id}
                className={`flex flex-col items-center ${
                  index <= currentStep ? "text-blue-600" : "text-slate-400"
                }`}
              >
                <div
                  className={`w-10 h-10 rounded-full flex items-center justify-center mb-2 ${
                    index < currentStep
                      ? "bg-blue-600 text-white"
                      : index === currentStep
                        ? "bg-blue-100 text-blue-600 border-2 border-blue-600"
                        : "bg-slate-100 text-slate-400"
                  }`}
                >
                  {index < currentStep ? (
                    <CheckCircle className="w-5 h-5" />
                  ) : (
                    <Icon className="w-5 h-5" />
                  )}
                </div>
                <span className="text-xs font-medium">{step.title}</span>
              </div>
            );
          })}
        </div>
      </div>

      {/* Form */}
      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
          <AnimatePresence mode="wait">
            <motion.div
              key={currentStep}
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
              transition={{ duration: 0.3 }}
            >
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    {React.createElement(STEPS[currentStep].icon, { className: "w-5 h-5" })}
                    {STEPS[currentStep].title}
                  </CardTitle>
                  <CardDescription>{STEPS[currentStep].description}</CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                  {/* Step 1: Basic Information */}
                  {currentStep === 0 && (
                    <div className="space-y-6">
                      <div className="grid grid-cols-2 gap-6">
                        <FormField
                          control={form.control}
                          name="name"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Organization Name *</FormLabel>
                              <FormControl>
                                <Input
                                  {...field}
                                  placeholder="Acme Corporation"
                                  className="w-full"
                                />
                              </FormControl>
                              <FormDescription>The display name for this tenant</FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="orgId"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Organization ID *</FormLabel>
                              <FormControl>
                                <Input {...field} placeholder="acme-corp" className="w-full" />
                              </FormControl>
                              <FormDescription>
                                Unique identifier (lowercase, hyphens only)
                              </FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>

                      <div className="grid grid-cols-2 gap-6">
                        <FormField
                          control={form.control}
                          name="adminName"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Admin Name *</FormLabel>
                              <FormControl>
                                <Input {...field} placeholder="John Doe" className="w-full" />
                              </FormControl>
                              <FormDescription>Primary administrator's full name</FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="adminEmail"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Admin Email *</FormLabel>
                              <FormControl>
                                <Input
                                  {...field}
                                  type="email"
                                  placeholder="admin@acme.com"
                                  className="w-full"
                                />
                              </FormControl>
                              <FormDescription>Email for onboarding instructions</FormDescription>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </div>

                      {/* Info Banner about Temporary Password */}
                      <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-md">
                        <div className="flex">
                          <div className="flex-shrink-0">
                            <Shield className="h-5 w-5 text-blue-400" />
                          </div>
                          <div className="ml-3">
                            <p className="text-sm text-blue-700">
                              A secure temporary password will be generated and sent to the admin email address.
                              The admin will be required to change it on first login.
                            </p>
                          </div>
                        </div>
                      </div>

                      <FormField
                        control={form.control}
                        name="companyWebsite"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Company Website (Optional)</FormLabel>
                            <FormControl>
                              <Input
                                {...field}
                                type="url"
                                placeholder="https://acme.com"
                                className="w-full"
                              />
                            </FormControl>
                            <FormDescription>Your organization's website URL</FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="sendEmail"
                        render={({ field }) => (
                          <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4 bg-slate-50">
                            <FormControl>
                              <Checkbox checked={field.value} onCheckedChange={field.onChange} />
                            </FormControl>
                            <div className="space-y-1 leading-none">
                              <FormLabel>Send onboarding email</FormLabel>
                              <FormDescription>
                                Send setup instructions and API keys to the admin email
                              </FormDescription>
                            </div>
                          </FormItem>
                        )}
                      />
                    </div>
                  )}

                  {/* Step 2: Module Selection */}
                  {currentStep === 1 && (
                    <div className="space-y-4">
                      <div className="mb-4">
                        <p className="text-sm text-slate-600">
                          Select the modules you want to enable for this tenant. You can always add
                          or remove modules later.
                        </p>
                      </div>

                      <FormField
                        control={form.control}
                        name="enabledModules"
                        render={({ field }) => (
                          <FormItem>
                            <div className="space-y-4">
                              {MODULES.map(module => {
                                const Icon = module.icon;
                                const isSelected = field.value?.includes(module.id) || false;

                                const handleToggle = () => {
                                  const currentValue = field.value || [];
                                  const newValue = isSelected
                                    ? currentValue.filter(v => v !== module.id)
                                    : [...currentValue, module.id];
                                  field.onChange(newValue);
                                };

                                return (
                                  <div
                                    key={module.id}
                                    className={`relative rounded-lg border-2 p-4 transition-all cursor-pointer hover:shadow-md ${
                                      isSelected
                                        ? "border-blue-500 bg-blue-50"
                                        : "border-slate-200 hover:border-slate-300"
                                    }`}
                                    onClick={handleToggle}
                                  >
                                    <div className="flex items-start space-x-4">
                                      <div
                                        className={`w-12 h-12 rounded-lg ${module.color} flex items-center justify-center text-white`}
                                      >
                                        <Icon className="w-6 h-6" />
                                      </div>
                                      <div className="flex-1">
                                        <div className="flex items-center justify-between">
                                          <h4 className="font-semibold text-slate-900">
                                            {module.name}
                                          </h4>
                                          <div
                                            className={`w-4 h-4 border rounded ${
                                              isSelected
                                                ? "bg-blue-500 border-blue-500"
                                                : "border-gray-300"
                                            } flex items-center justify-center`}
                                          >
                                            {isSelected && (
                                              <div className="w-2 h-2 bg-white rounded-sm"></div>
                                            )}
                                          </div>
                                        </div>
                                        <p className="text-sm text-slate-600 mt-1">
                                          {module.description}
                                        </p>
                                        {module.providers && (
                                          <div className="flex flex-wrap gap-2 mt-2">
                                            {module.providers.map(provider => (
                                              <Badge
                                                key={provider}
                                                variant="secondary"
                                                className="text-xs"
                                              >
                                                {provider}
                                              </Badge>
                                            ))}
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>
                  )}

                  {/* Step 3: Module Configuration */}
                  {currentStep === 2 && (
                    <div className="space-y-6">
                      {watchedModules.length === 0 ? (
                        <div className="text-center py-8 text-slate-500">
                          <Settings className="w-12 h-12 mx-auto mb-4 text-slate-300" />
                          <p>No modules selected. Go back to select modules to configure.</p>
                        </div>
                      ) : (
                        <div className="space-y-6">
                          {/* Authentication Module Configuration */}
                          {watchedModules.includes("authentication") && (
                            <div className="space-y-4">
                              <h3 className="font-semibold text-lg flex items-center gap-2">
                                <Lock className="w-5 h-5" />
                                Authentication Configuration
                              </h3>

                              <FormField
                                control={form.control}
                                name="moduleConfigs.authentication.providers"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Select Authentication Providers</FormLabel>
                                    <div className="grid grid-cols-2 gap-4">
                                      {["auth0", "azure-ad", "local", "saml"].map(provider => {
                                        const currentProviders = field.value || [];
                                        const isSelected = currentProviders.includes(
                                          provider as any
                                        );

                                        const handleToggle = () => {
                                          const newValue = isSelected
                                            ? currentProviders.filter(v => v !== provider)
                                            : [...currentProviders, provider];
                                          field.onChange(newValue);
                                        };

                                        return (
                                          <div
                                            key={provider}
                                            className={`border rounded-lg p-3 cursor-pointer hover:border-blue-300 transition-colors ${
                                              isSelected
                                                ? "border-blue-500 bg-blue-50"
                                                : "border-slate-200"
                                            }`}
                                            onClick={handleToggle}
                                          >
                                            <div className="flex items-center justify-between">
                                              <span className="font-medium capitalize">
                                                {provider.replace("-", " ").toUpperCase()}
                                              </span>
                                              <div
                                                className={`w-4 h-4 border rounded ${
                                                  isSelected
                                                    ? "bg-blue-500 border-blue-500"
                                                    : "border-gray-300"
                                                } flex items-center justify-center`}
                                              >
                                                {isSelected && (
                                                  <div className="w-2 h-2 bg-white rounded-sm"></div>
                                                )}
                                              </div>
                                            </div>
                                          </div>
                                        );
                                      })}
                                    </div>
                                    <FormMessage />
                                  </FormItem>
                                )}
                              />

                              {/* Auth0 Configuration */}
                              {watchedAuthProviders?.includes("auth0") && (
                                <div className="space-y-4 pl-4 border-l-2 border-blue-200">
                                  <h4 className="font-medium">Auth0 Configuration</h4>
                                  <div className="grid grid-cols-2 gap-4">
                                    <FormField
                                      control={form.control}
                                      name="moduleConfigs.authentication.auth0.domain"
                                      render={({ field }) => (
                                        <FormItem>
                                          <FormLabel>Domain</FormLabel>
                                          <FormControl>
                                            <Input {...field} placeholder="your-tenant.auth0.com" />
                                          </FormControl>
                                        </FormItem>
                                      )}
                                    />
                                    <FormField
                                      control={form.control}
                                      name="moduleConfigs.authentication.auth0.clientId"
                                      render={({ field }) => (
                                        <FormItem>
                                          <FormLabel>Client ID</FormLabel>
                                          <FormControl>
                                            <Input {...field} placeholder="Your Auth0 Client ID" />
                                          </FormControl>
                                        </FormItem>
                                      )}
                                    />
                                  </div>
                                </div>
                              )}

                              {/* Azure AD Configuration */}
                              {watchedAuthProviders?.includes("azure-ad") && (
                                <div className="space-y-4 pl-4 border-l-2 border-blue-200">
                                  <h4 className="font-medium">Azure AD Configuration</h4>
                                  <div className="grid grid-cols-2 gap-4">
                                    <FormField
                                      control={form.control}
                                      name="moduleConfigs.authentication.azureAd.tenantId"
                                      render={({ field }) => (
                                        <FormItem>
                                          <FormLabel>Tenant ID</FormLabel>
                                          <FormControl>
                                            <Input {...field} placeholder="Your Azure Tenant ID" />
                                          </FormControl>
                                        </FormItem>
                                      )}
                                    />
                                    <FormField
                                      control={form.control}
                                      name="moduleConfigs.authentication.azureAd.clientId"
                                      render={({ field }) => (
                                        <FormItem>
                                          <FormLabel>Client ID</FormLabel>
                                          <FormControl>
                                            <Input {...field} placeholder="Your Azure Client ID" />
                                          </FormControl>
                                        </FormItem>
                                      )}
                                    />
                                  </div>
                                </div>
                              )}
                            </div>
                          )}

                          {/* RBAC Configuration */}
                          {watchedModules.includes("rbac") && (
                            <div className="space-y-4">
                              <h3 className="font-semibold text-lg flex items-center gap-2">
                                <Users className="w-5 h-5" />
                                RBAC Configuration
                              </h3>

                              <FormField
                                control={form.control}
                                name="moduleConfigs.rbac.defaultRoles"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Default Roles</FormLabel>
                                    <FormControl>
                                      <Textarea
                                        placeholder="Enter default roles (one per line)&#10;admin&#10;user&#10;viewer"
                                        onChange={e => {
                                          const roles = e.target.value
                                            .split("\n")
                                            .filter(r => r.trim());
                                          field.onChange(roles);
                                        }}
                                      />
                                    </FormControl>
                                    <FormDescription>
                                      Define default roles for this tenant
                                    </FormDescription>
                                  </FormItem>
                                )}
                              />
                            </div>
                          )}

                          {/* Logging Configuration */}
                          {watchedModules.includes("logging") && (
                            <div className="space-y-4">
                              <h3 className="font-semibold text-lg flex items-center gap-2">
                                <Activity className="w-5 h-5" />
                                Logging Configuration
                              </h3>

                              <FormField
                                control={form.control}
                                name="moduleConfigs.logging.levels"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Log Levels</FormLabel>
                                    <div className="grid grid-cols-3 gap-4">
                                      {["error", "warn", "info", "debug", "trace"].map(level => {
                                        const currentLevels = field.value || [];
                                        const isSelected = currentLevels.includes(level as any);

                                        const handleToggle = () => {
                                          const newValue = isSelected
                                            ? currentLevels.filter(v => v !== level)
                                            : [...currentLevels, level];
                                          field.onChange(newValue);
                                        };

                                        return (
                                          <div
                                            key={level}
                                            className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-2 rounded"
                                            onClick={handleToggle}
                                          >
                                            <div
                                              className={`w-4 h-4 border rounded ${
                                                isSelected
                                                  ? "bg-blue-500 border-blue-500"
                                                  : "border-gray-300"
                                              } flex items-center justify-center`}
                                            >
                                              {isSelected && (
                                                <div className="w-2 h-2 bg-white rounded-sm"></div>
                                              )}
                                            </div>
                                            <Label className="capitalize cursor-pointer">
                                              {level}
                                            </Label>
                                          </div>
                                        );
                                      })}
                                    </div>
                                    <FormDescription>
                                      Select which log levels to capture
                                    </FormDescription>
                                  </FormItem>
                                )}
                              />
                            </div>
                          )}

                          {/* Notifications Configuration */}
                          {watchedModules.includes("notifications") && (
                            <div className="space-y-4">
                              <h3 className="font-semibold text-lg flex items-center gap-2">
                                <Bell className="w-5 h-5" />
                                Notifications Configuration
                              </h3>

                              <FormField
                                control={form.control}
                                name="moduleConfigs.notifications.channels"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Notification Channels</FormLabel>
                                    <div className="grid grid-cols-2 gap-4">
                                      {["email", "sms", "push", "webhook"].map(channel => {
                                        const currentChannels = field.value || [];
                                        const isSelected = currentChannels.includes(channel as any);

                                        const handleToggle = () => {
                                          const newValue = isSelected
                                            ? currentChannels.filter(v => v !== channel)
                                            : [...currentChannels, channel];
                                          field.onChange(newValue);
                                        };

                                        return (
                                          <div
                                            key={channel}
                                            className="flex items-center space-x-2 cursor-pointer hover:bg-slate-50 p-2 rounded"
                                            onClick={handleToggle}
                                          >
                                            <div
                                              className={`w-4 h-4 border rounded ${
                                                isSelected
                                                  ? "bg-blue-500 border-blue-500"
                                                  : "border-gray-300"
                                              } flex items-center justify-center`}
                                            >
                                              {isSelected && (
                                                <div className="w-2 h-2 bg-white rounded-sm"></div>
                                              )}
                                            </div>
                                            <Label className="capitalize cursor-pointer">
                                              {channel}
                                            </Label>
                                          </div>
                                        );
                                      })}
                                    </div>
                                  </FormItem>
                                )}
                              />
                            </div>
                          )}

                          {/* AI Copilot Configuration */}
                          {watchedModules.includes("aiCopilot") && (
                            <div className="space-y-4">
                              <h3 className="font-semibold text-lg flex items-center gap-2">
                                <Bot className="w-5 h-5" />
                                AI Copilot Configuration
                              </h3>

                              <FormField
                                control={form.control}
                                name="moduleConfigs.aiCopilot.provider"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>AI Provider</FormLabel>
                                    <Select
                                      onValueChange={field.onChange}
                                      defaultValue={field.value}
                                    >
                                      <FormControl>
                                        <SelectTrigger>
                                          <SelectValue placeholder="Select AI provider" />
                                        </SelectTrigger>
                                      </FormControl>
                                      <SelectContent>
                                        <SelectItem value="openai">OpenAI</SelectItem>
                                        <SelectItem value="azure-openai">Azure OpenAI</SelectItem>
                                        <SelectItem value="anthropic">Anthropic</SelectItem>
                                        <SelectItem value="google">Google AI</SelectItem>
                                      </SelectContent>
                                    </Select>
                                  </FormItem>
                                )}
                              />

                              <FormField
                                control={form.control}
                                name="moduleConfigs.aiCopilot.model"
                                render={({ field }) => (
                                  <FormItem>
                                    <FormLabel>Model</FormLabel>
                                    <FormControl>
                                      <Input {...field} placeholder="e.g., gpt-4, claude-3" />
                                    </FormControl>
                                  </FormItem>
                                )}
                              />
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Step 4: Review */}
                  {currentStep === 3 && (
                    <div className="space-y-6">
                      <div className="bg-slate-50 rounded-lg p-6 space-y-4">
                        <h3 className="font-semibold text-lg">Summary</h3>

                        <div className="space-y-3">
                          <div>
                            <span className="text-sm text-slate-600">Organization:</span>
                            <p className="font-medium">{form.getValues("name")}</p>
                          </div>

                          <div>
                            <span className="text-sm text-slate-600">Organization ID:</span>
                            <p className="font-mono text-sm">{form.getValues("orgId")}</p>
                          </div>

                          <div>
                            <span className="text-sm text-slate-600">Admin:</span>
                            <p className="font-medium">
                              {form.getValues("adminName")} ({form.getValues("adminEmail")})
                            </p>
                          </div>

                          <div>
                            <span className="text-sm text-slate-600">Selected Modules:</span>
                            <div className="flex flex-wrap gap-2 mt-2">
                              {watchedModules.map(moduleId => {
                                const module = MODULES.find(m => m.id === moduleId);
                                return (
                                  <Badge key={moduleId} variant="secondary">
                                    {module?.name}
                                  </Badge>
                                );
                              })}
                            </div>
                          </div>

                          {watchedModules.includes("authentication") &&
                            watchedAuthProviders?.length > 0 && (
                              <div>
                                <span className="text-sm text-slate-600">
                                  Authentication Providers:
                                </span>
                                <div className="flex flex-wrap gap-2 mt-2">
                                  {watchedAuthProviders.map(provider => (
                                    <Badge key={provider} variant="outline">
                                      {provider.replace("-", " ").toUpperCase()}
                                    </Badge>
                                  ))}
                                </div>
                              </div>
                            )}
                        </div>
                      </div>

                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="text-sm text-blue-800">
                          <strong>What happens next:</strong> After clicking "Onboard Tenant", an
                          email will be sent to {form.getValues("adminEmail")} with:
                        </p>
                        <ul className="list-disc list-inside text-sm text-blue-700 mt-2 space-y-1">
                          <li>Integration guides for selected modules</li>
                          <li>API keys and credentials</li>
                          <li>Tenant portal access link</li>
                          <li>Tenant ID and configuration details</li>
                        </ul>
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            </motion.div>
          </AnimatePresence>

          {/* Navigation Buttons */}
          <div className="flex justify-between">
            <Button
              type="button"
              variant="outline"
              onClick={handleBack}
              disabled={currentStep === 0}
              className="flex items-center gap-2"
            >
              <ArrowLeft className="w-4 h-4" />
              Back
            </Button>

            {currentStep < STEPS.length - 1 ? (
              <Button type="button" onClick={handleNext} className="flex items-center gap-2">
                Next
                <ArrowRight className="w-4 h-4" />
              </Button>
            ) : (
              <div className="flex items-center gap-3">
                {/* Extra affordance to go back to Modules and tweak selections ("Back & Mix") */}
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => setCurrentStep(1)}
                  className="flex items-center gap-2"
                >
                  Back & Mix
                </Button>

                <Button
                  type="submit"
                  disabled={createTenant.isPending}
                  className="flex items-center gap-2"
                >
                  {createTenant.isPending ? (
                    <>Creating...</>
                  ) : (
                    <>
                      <CheckCircle className="w-4 h-4" />
                      Onboard Tenant
                    </>
                  )}
                </Button>
              </div>
            )}
          </div>
        </form>
      </Form>
    </div>
  );
}
