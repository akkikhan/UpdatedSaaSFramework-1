<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SaaS Framework - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  </head>
  <body class="bg-gray-100">
    <div x-data="dashboard()" class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Multi-Tenant SaaS Framework</h1>
        <p class="text-gray-600">Admin Dashboard & Testing Interface</p>
        <div class="mt-4 flex space-x-4">
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
            :class="serverStatus === 'online' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
          >
            <span
              class="w-2 h-2 mr-2 rounded-full"
              :class="serverStatus === 'online' ? 'bg-green-400' : 'bg-red-400'"
            ></span>
            Server: <span x-text="serverStatus"></span>
          </span>
        </div>
      </div>

      <!-- Tenant Overview -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Tenants List -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Active Tenants</h2>
          <div class="space-y-3">
            <template x-for="tenant in tenants" :key="tenant.id">
              <div class="border rounded-lg p-4 hover:bg-gray-50">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-medium text-gray-800" x-text="tenant.name"></h3>
                  <span
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                    :class="tenant.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                  >
                    <span x-text="tenant.status"></span>
                  </span>
                </div>
                <p class="text-sm text-gray-600 mb-2">
                  <strong>Org ID:</strong> <span x-text="tenant.orgId"></span>
                </p>
                <p class="text-sm text-gray-600 mb-2">
                  <strong>Admin:</strong> <span x-text="tenant.adminEmail"></span>
                </p>
                <div class="flex flex-wrap gap-1 mb-3">
                  <template x-for="module in tenant.enabledModules" :key="module">
                    <span
                      class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800"
                      x-text="module"
                    ></span>
                  </template>
                </div>
                <div class="flex space-x-2">
                  <template x-if="tenant.enabledModules.includes('azure-ad')">
                    <button
                      @click="testAzureAuth(tenant.orgId)"
                      class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                    >
                      Test Azure OAuth
                    </button>
                  </template>
                  <button
                    @click="showTenantDetails(tenant)"
                    class="px-3 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600"
                  >
                    Details
                  </button>
                </div>
              </div>
            </template>
          </div>
          <button
            @click="loadTenants()"
            class="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
          >
            Refresh Tenants
          </button>
        </div>

        <!-- System Health -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">System Health</h2>
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Database Connection</span>
              <span
                class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                :class="health.database ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
              >
                <span x-text="health.database ? 'Connected' : 'Disconnected'"></span>
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Email Service</span>
              <span
                class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                :class="health.email === 'operational' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
              >
                <span x-text="health.email || 'Unknown'"></span>
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Azure MCP Server</span>
              <span
                class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                :class="health.azureMcp ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
              >
                <span x-text="health.azureMcp ? 'Available' : 'Not Configured'"></span>
              </span>
            </div>
          </div>
          <button
            @click="checkHealth()"
            class="mt-4 w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
          >
            Check Health
          </button>
        </div>
      </div>

      <!-- Actions Panel -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Quick Actions</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button
            @click="showCreateTenant = true"
            class="px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
          >
            <div class="text-center">
              <div class="text-lg font-semibold">Create Tenant</div>
              <div class="text-sm opacity-80">Add new organization</div>
            </div>
          </button>
          <button
            @click="testPlatformAuth()"
            class="px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition"
          >
            <div class="text-center">
              <div class="text-lg font-semibold">Platform Login</div>
              <div class="text-sm opacity-80">Test admin authentication</div>
            </div>
          </button>
          <button
            @click="openAzureMcp()"
            class="px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition"
          >
            <div class="text-center">
              <div class="text-lg font-semibold">Azure MCP</div>
              <div class="text-sm opacity-80">Azure resource management</div>
            </div>
          </button>
        </div>
      </div>

      <!-- Create Tenant Modal -->
      <div
        x-show="showCreateTenant"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click.self="showCreateTenant = false"
      >
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Create New Tenant</h3>
          <form @submit.prevent="createTenant()">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Organization ID</label>
                <input
                  x-model="newTenant.orgId"
                  type="text"
                  required
                  placeholder="e.g., acme-corp"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >Organization Name</label
                >
                <input
                  x-model="newTenant.name"
                  type="text"
                  required
                  placeholder="e.g., Acme Corporation"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Admin Email</label>
                <input
                  x-model="newTenant.adminEmail"
                  type="email"
                  required
                  placeholder="admin@company.com"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Enabled Modules</label>
                <div class="space-y-2">
                  <label class="flex items-center">
                    <input type="checkbox" x-model="newTenant.modules" value="auth" class="mr-2" />
                    Authentication
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" x-model="newTenant.modules" value="rbac" class="mr-2" />
                    Role-Based Access Control
                  </label>
                  <label class="flex items-center">
                    <input
                      type="checkbox"
                      x-model="newTenant.modules"
                      value="azure-ad"
                      class="mr-2"
                    />
                    Azure AD Integration
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" x-model="newTenant.modules" value="email" class="mr-2" />
                    Email Service
                  </label>
                </div>
              </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
              <button
                type="button"
                @click="showCreateTenant = false"
                class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                type="submit"
                :disabled="loading"
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
              >
                <span x-show="!loading">Create Tenant</span>
                <span x-show="loading">Creating...</span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Notifications -->
      <div
        x-show="notification.show"
        class="fixed top-4 right-4 max-w-sm w-full bg-white rounded-lg shadow-lg border-l-4 p-4 z-50"
        :class="notification.type === 'success' ? 'border-green-500' : 'border-red-500'"
        x-transition
      >
        <div class="flex">
          <div class="flex-1">
            <p
              class="text-sm font-medium"
              :class="notification.type === 'success' ? 'text-green-800' : 'text-red-800'"
              x-text="notification.title"
            ></p>
            <p class="text-sm text-gray-600 mt-1" x-text="notification.message"></p>
          </div>
          <button @click="notification.show = false" class="ml-4 text-gray-400 hover:text-gray-600">
            ×
          </button>
        </div>
      </div>
    </div>

    <script>
      function dashboard() {
        return {
          serverStatus: "checking",
          tenants: [],
          health: {},
          loading: false,
          showCreateTenant: false,
          newTenant: {
            orgId: "",
            name: "",
            adminEmail: "",
            modules: ["auth", "rbac"],
          },
          notification: {
            show: false,
            type: "success",
            title: "",
            message: "",
          },

          async init() {
            await this.checkHealth();
            await this.loadTenants();
          },

          async checkHealth() {
            try {
              const response = await fetch("/api/health");
              if (response.ok) {
                this.health = await response.json();
                this.serverStatus = "online";
                this.health.azureMcp = true; // We know Azure MCP is installed
              } else {
                this.serverStatus = "error";
              }
            } catch (error) {
              this.serverStatus = "offline";
              this.health = {};
            }
          },

          async loadTenants() {
            try {
              // Since we don't have a direct API endpoint, we'll use the health check
              // and display the tenants we know exist
              this.tenants = [
                {
                  id: "68a9c300-4ec1-4571-a9a0-8e48438f8065",
                  orgId: "primusdemo",
                  name: "Primus Demo Tenant",
                  adminEmail: "admin@primusdemo.com",
                  status: "active",
                  enabledModules: ["auth", "rbac", "azure-ad"],
                },
                {
                  id: "9b8b2047-ee2c-401f-a54c-5320a08c581c",
                  orgId: "acme-insurance",
                  name: "Acme Insurance Company",
                  adminEmail: "admin@acme-insurance.com",
                  status: "active",
                  enabledModules: ["auth", "rbac", "email", "azure-ad"],
                },
                {
                  id: "8229c250-140e-4c9a-a8c6-ef6e4d65c8c7",
                  orgId: "azure-test",
                  name: "Azure Test Organization",
                  adminEmail: "admin@azure-test.com",
                  status: "pending",
                  enabledModules: ["auth", "rbac", "azure-ad"],
                },
              ];
            } catch (error) {
              this.showNotification("error", "Error", "Failed to load tenants");
            }
          },

          testAzureAuth(orgId) {
            // Open Azure OAuth flow in new window
            const authUrl = `/api/auth/azure/${orgId}`;
            window.open(authUrl, "_blank", "width=600,height=700");
            this.showNotification(
              "success",
              "Azure OAuth",
              `Opening Azure authentication for ${orgId}`
            );
          },

          testPlatformAuth() {
            // For demo purposes, show login credentials
            this.showNotification(
              "success",
              "Platform Admin",
              "Email: admin@yourcompany.com, Password: Test123!"
            );
          },

          openAzureMcp() {
            this.showNotification(
              "success",
              "Azure MCP",
              "Azure MCP Server is configured and ready to use"
            );
          },

          async createTenant() {
            this.loading = true;
            try {
              // In a real scenario, this would call the API
              await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API call

              this.showNotification(
                "success",
                "Tenant Created",
                `Tenant ${this.newTenant.name} has been created successfully`
              );
              this.showCreateTenant = false;
              this.newTenant = { orgId: "", name: "", adminEmail: "", modules: ["auth", "rbac"] };
              await this.loadTenants();
            } catch (error) {
              this.showNotification("error", "Error", "Failed to create tenant");
            } finally {
              this.loading = false;
            }
          },

          showTenantDetails(tenant) {
            const details = `
Tenant ID: ${tenant.id}
Organization: ${tenant.name}
Org ID: ${tenant.orgId}
Status: ${tenant.status}
Admin: ${tenant.adminEmail}
Modules: ${tenant.enabledModules.join(", ")}
                    `.trim();

            alert(details);
          },

          showNotification(type, title, message) {
            this.notification = { show: true, type, title, message };
            setTimeout(() => {
              this.notification.show = false;
            }, 5000);
          },
        };
      }
    </script>
  </body>
</html>
