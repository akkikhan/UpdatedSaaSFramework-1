<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User & Role Management Test Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .response-container {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
                üè¢ User & Role Management Test Interface
            </h1>
            <p class="text-center text-gray-600 mb-6">
                Complete testing suite for tenant user management functionality
            </p>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h2 class="text-lg font-semibold text-blue-800 mb-2">‚úÖ Test Coverage</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                    <div>
                        <h3 class="font-medium text-blue-700">User CRUD Operations</h3>
                        <ul class="text-blue-600 mt-1">
                            <li>‚Ä¢ Create Users</li>
                            <li>‚Ä¢ Read Users (with roles)</li>
                            <li>‚Ä¢ Update Users</li>
                            <li>‚Ä¢ Delete Users</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-medium text-blue-700">Role CRUD Operations</h3>
                        <ul class="text-blue-600 mt-1">
                            <li>‚Ä¢ Create Roles</li>
                            <li>‚Ä¢ Read Roles (with user counts)</li>
                            <li>‚Ä¢ Update Roles</li>
                            <li>‚Ä¢ Delete Roles</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-medium text-blue-700">Role Assignment</h3>
                        <ul class="text-blue-600 mt-1">
                            <li>‚Ä¢ Assign Roles to Users</li>
                            <li>‚Ä¢ Remove Roles from Users</li>
                            <li>‚Ä¢ View User Roles</li>
                            <li>‚Ä¢ Role-User Relationship</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Quick Access Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üöÄ Quick Access</h2>
                
                <div class="space-y-3">
                    <button onclick="openTenantPortal()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200">
                        üè¢ Open Tenant Portal (ACME)
                    </button>
                    
                    <button onclick="runFullTest()" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200">
                        üß™ Run Complete Test Suite
                    </button>
                    
                    <button onclick="populateTestData()" 
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200">
                        üìä Populate Test Data
                    </button>
                    
                    <button onclick="clearLogs()" 
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200">
                        üóëÔ∏è Clear Test Logs
                    </button>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-700 mb-2">üìã Test Status</h3>
                    <div id="testStatus" class="text-sm">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Ready to test</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Testing Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üîß Manual API Testing</h2>
                
                <div class="space-y-4">
                    <!-- Test Users Endpoint -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Test Users API</label>
                        <div class="flex space-x-2">
                            <button onclick="testUsersAPI()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                                GET Users
                            </button>
                            <button onclick="createTestUser()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">
                                Create User
                            </button>
                        </div>
                    </div>

                    <!-- Test Roles Endpoint -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Test Roles API</label>
                        <div class="flex space-x-2">
                            <button onclick="testRolesAPI()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                                GET Roles
                            </button>
                            <button onclick="createTestRole()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">
                                Create Role
                            </button>
                        </div>
                    </div>

                    <!-- Test Role Assignment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Test Role Assignment</label>
                        <div class="flex space-x-2">
                            <button onclick="testRoleAssignment()" 
                                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded text-sm">
                                Assign Role
                            </button>
                            <button onclick="testUserRoles()" 
                                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded text-sm">
                                Get User Roles
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Test Results & Logs</h2>
            <div id="testResults" class="response-container bg-gray-50 border rounded-lg p-4 min-h-[300px] font-mono text-sm">
                <div class="text-gray-500">Test results will appear here...</div>
            </div>
        </div>

        <!-- Features Validation -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">‚úÖ Feature Validation</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="border rounded-lg p-4">
                    <h3 class="font-medium text-gray-700 mb-3">User Management</h3>
                    <div id="userManagementStatus" class="space-y-2 text-sm">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Create User Form</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Edit User Form</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Delete User</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>User Roles Display</span>
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Role Management</h3>
                    <div id="roleManagementStatus" class="space-y-2 text-sm">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Create Role Form</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Edit Role Form</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Delete Role</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Role User Count</span>
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Role Assignment</h3>
                    <div id="roleAssignmentStatus" class="space-y-2 text-sm">
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Manage User Roles Modal</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Assign Roles</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Remove Roles</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            <span>Scrolling Fix</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentTenantId = null;

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `mb-2 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateStatus(element, success, message) {
            const indicator = element.querySelector('.w-3');
            const text = element.querySelector('span:last-child');
            
            indicator.className = `w-3 h-3 rounded-full mr-2 ${success ? 'bg-green-500' : 'bg-red-500'}`;
            text.textContent = message;
        }

        function clearLogs() {
            document.getElementById('testResults').innerHTML = '<div class="text-gray-500">Test results cleared...</div>';
        }

        // API utility
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(`API Error: ${result.message || response.statusText}`);
                }
                
                return result;
            } catch (error) {
                log(`‚ùå Failed to call ${endpoint}: ${error.message}`, 'error');
                throw error;
            }
        }

        // Get tenant ID
        async function getTenantId() {
            if (!currentTenantId) {
                const tenants = await apiCall('/tenants');
                const tenant = tenants.find(t => t.orgId === 'acme');
                if (!tenant) {
                    throw new Error('ACME tenant not found');
                }
                currentTenantId = tenant.id;
            }
            return currentTenantId;
        }

        // Quick access functions
        function openTenantPortal() {
            window.open('http://localhost:3001/tenant/acme/dashboard', '_blank');
            log('üîó Opened tenant portal in new tab', 'success');
        }

        // API Testing functions
        async function testUsersAPI() {
            try {
                log('üîç Testing GET /users API...');
                const tenantId = await getTenantId();
                const users = await apiCall(`/tenants/${tenantId}/users`);
                log(`‚úÖ Found ${users.length} users`);
                
                users.forEach((user, index) => {
                    const roleCount = user.roles ? user.roles.length : 0;
                    const roleNames = user.roles ? user.roles.map(r => r.name).join(', ') : 'No roles';
                    log(`   ${index + 1}. ${user.firstName} ${user.lastName} (${user.email}) - Roles: ${roleNames}`);
                });
                
                return users;
            } catch (error) {
                log(`‚ùå Users API test failed: ${error.message}`, 'error');
            }
        }

        async function testRolesAPI() {
            try {
                log('üîç Testing GET /roles API...');
                const tenantId = await getTenantId();
                const roles = await apiCall(`/tenants/${tenantId}/roles`);
                log(`‚úÖ Found ${roles.length} roles`);
                
                roles.forEach((role, index) => {
                    const userCount = role.userCount || 0;
                    const permissionCount = role.permissions ? role.permissions.length : 0;
                    log(`   ${index + 1}. ${role.name} (${userCount} users, ${permissionCount} permissions)`);
                });
                
                return roles;
            } catch (error) {
                log(`‚ùå Roles API test failed: ${error.message}`, 'error');
            }
        }

        async function createTestUser() {
            try {
                log('üë§ Creating test user...');
                const tenantId = await getTenantId();
                const timestamp = Date.now();
                
                const userData = {
                    firstName: 'Test',
                    lastName: 'User',
                    email: `test.user.${timestamp}@acme.com`,
                    password: 'Test123!',
                    status: 'active'
                };
                
                const user = await apiCall(`/tenants/${tenantId}/users`, 'POST', userData);
                log(`‚úÖ Created user: ${user.firstName} ${user.lastName} (${user.email})`, 'success');
                
                return user;
            } catch (error) {
                log(`‚ùå User creation failed: ${error.message}`, 'error');
            }
        }

        async function createTestRole() {
            try {
                log('üõ°Ô∏è Creating test role...');
                const tenantId = await getTenantId();
                const timestamp = Date.now();
                
                const roleData = {
                    name: `Test Role ${timestamp}`,
                    description: 'Automatically created test role',
                    permissions: ['users.read', 'reports.read', 'settings.read']
                };
                
                const role = await apiCall(`/tenants/${tenantId}/roles`, 'POST', roleData);
                log(`‚úÖ Created role: ${role.name} with ${role.permissions.length} permissions`, 'success');
                
                return role;
            } catch (error) {
                log(`‚ùå Role creation failed: ${error.message}`, 'error');
            }
        }

        async function testRoleAssignment() {
            try {
                log('üîó Testing role assignment...');
                const tenantId = await getTenantId();
                
                // Get users and roles
                const users = await apiCall(`/tenants/${tenantId}/users`);
                const roles = await apiCall(`/tenants/${tenantId}/roles`);
                
                if (users.length === 0) {
                    log('‚ö†Ô∏è No users found. Creating a test user first...');
                    await createTestUser();
                    const newUsers = await apiCall(`/tenants/${tenantId}/users`);
                    if (newUsers.length === 0) {
                        throw new Error('Failed to create test user');
                    }
                }
                
                if (roles.length === 0) {
                    log('‚ö†Ô∏è No roles found. Creating a test role first...');
                    await createTestRole();
                    const newRoles = await apiCall(`/tenants/${tenantId}/roles`);
                    if (newRoles.length === 0) {
                        throw new Error('Failed to create test role');
                    }
                }
                
                // Refresh data
                const finalUsers = await apiCall(`/tenants/${tenantId}/users`);
                const finalRoles = await apiCall(`/tenants/${tenantId}/roles`);
                
                const user = finalUsers[0];
                const role = finalRoles[0];
                
                // Assign role to user
                await apiCall(`/tenants/${tenantId}/users/${user.id}/roles`, 'POST', {
                    roleId: role.id
                });
                
                log(`‚úÖ Assigned role "${role.name}" to user "${user.firstName} ${user.lastName}"`, 'success');
                
                // Verify assignment
                const userRoles = await apiCall(`/tenants/${tenantId}/users/${user.id}/roles`);
                log(`üîç User now has ${userRoles.length} role(s): ${userRoles.map(r => r.name).join(', ')}`);
                
            } catch (error) {
                log(`‚ùå Role assignment test failed: ${error.message}`, 'error');
            }
        }

        async function testUserRoles() {
            try {
                log('üîç Testing user roles query...');
                const tenantId = await getTenantId();
                const users = await apiCall(`/tenants/${tenantId}/users`);
                
                if (users.length === 0) {
                    log('‚ö†Ô∏è No users found to test');
                    return;
                }
                
                for (const user of users.slice(0, 3)) {
                    try {
                        const userRoles = await apiCall(`/tenants/${tenantId}/users/${user.id}/roles`);
                        log(`üë§ ${user.firstName} ${user.lastName}: ${userRoles.length} role(s) - ${userRoles.map(r => r.name).join(', ') || 'No roles'}`);
                    } catch (error) {
                        log(`‚ùå Failed to get roles for ${user.firstName} ${user.lastName}`);
                    }
                }
                
            } catch (error) {
                log(`‚ùå User roles test failed: ${error.message}`, 'error');
            }
        }

        async function populateTestData() {
            log('üöÄ Starting test data population...');
            
            try {
                // Create some test roles
                log('üìù Creating sample roles...');
                const rolePromises = [
                    createTestRole(),
                    apiCall(`/tenants/${await getTenantId()}/roles`, 'POST', {
                        name: 'Manager',
                        description: 'Team manager with user and report access',
                        permissions: ['users.read', 'users.create', 'users.update', 'reports.read', 'reports.create']
                    }).catch(() => log('‚ö†Ô∏è Manager role might already exist')),
                    apiCall(`/tenants/${await getTenantId()}/roles`, 'POST', {
                        name: 'Analyst',
                        description: 'Data analyst with read-only access',
                        permissions: ['users.read', 'reports.read']
                    }).catch(() => log('‚ö†Ô∏è Analyst role might already exist'))
                ];
                
                await Promise.all(rolePromises);
                
                // Create some test users
                log('üë• Creating sample users...');
                const userPromises = [
                    createTestUser(),
                    apiCall(`/tenants/${await getTenantId()}/users`, 'POST', {
                        firstName: 'John',
                        lastName: 'Smith',
                        email: 'john.smith@acme.com',
                        password: 'Test123!',
                        status: 'active'
                    }).catch(() => log('‚ö†Ô∏è John Smith might already exist')),
                    apiCall(`/tenants/${await getTenantId()}/users`, 'POST', {
                        firstName: 'Sarah',
                        lastName: 'Johnson',
                        email: 'sarah.johnson@acme.com',
                        password: 'Test123!',
                        status: 'active'
                    }).catch(() => log('‚ö†Ô∏è Sarah Johnson might already exist'))
                ];
                
                await Promise.all(userPromises);
                
                log('‚úÖ Test data population completed!', 'success');
                
                // Test some role assignments
                await testRoleAssignment();
                
            } catch (error) {
                log(`‚ùå Test data population failed: ${error.message}`, 'error');
            }
        }

        async function runFullTest() {
            log('üß™ Starting comprehensive test suite...');
            
            try {
                // Test all endpoints
                await testUsersAPI();
                await testRolesAPI();
                await testUserRoles();
                
                log('‚úÖ All API tests completed successfully!', 'success');
                log('üåê You can now test the UI functionality in the tenant portal', 'success');
                
            } catch (error) {
                log(`‚ùå Full test suite failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('üöÄ User & Role Management Test Interface Loaded');
        log('üìã Ready to test complete user management functionality');
        log('üîó Use the buttons above to run tests or open the tenant portal');
    </script>
</body>
</html>
